<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Your Profile</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; color:#000080; user-select:none; background:#f0f4ff; }
  header { background:linear-gradient(90deg,#3399ff,#9966ff); padding:20px 30px; box-shadow:0 3px 6px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .logo-container { display:flex; align-items:baseline; gap:15px; }
  .logo { font-size:36px; font-weight:bold; color:#fff; }
.tagline { font-size:18px; font-style:italic; font-weight:bold; color:#ffe066; text-shadow:1px 1px 0 #000033; }
  nav { display:flex; gap:10px; align-items:center; }
  button { padding:8px 14px; font-weight:bold; border-radius:3px; border:none; cursor:pointer; color:#000080; background:#ffcc00; box-shadow:1px 1px 0 #333; transition:background 0.2s; }
  button:hover { background:#ffff66; }
  main { max-width:700px; margin:30px auto; padding:20px; background:#ffffffcc; border:3px solid #9966ff; border-radius:6px; box-shadow:0 4px 10px rgba(153,102,255,0.3); transition:background 0.3s; }
  h1 { margin-bottom:10px; }
  label { display:block; margin:10px 0 5px; font-weight:bold; }
input[type="text"], input[type="url"], input[type="date"], textarea, select {
  width: calc(100% - 20px);
  padding: 8px;
  font-size: 14px;
  border: 2px solid #9966ff;
  border-radius: 4px;
  margin: 0 auto;
  display: block;
}
  textarea { resize:vertical; min-height:60px; }
  #friends-container p, #blog-posts-container p, #friend-requests-container p { margin:4px 0; }
  #friends-container a { color:#3399ff; text-decoration:none; }
  #friends-container a:hover { text-decoration:underline; }
  #avatar-username-container { display:flex; align-items:center; gap:15px; margin-bottom:15px; flex-direction:column; }
  #profile-avatar img { width:150px; height:150px; border-radius:50%; object-fit:cover; background:#ccc; }
  #username-input { font-size:20px; text-align:center; }
  #dm-btn-profile { margin-top:10px; background:#3399ff; color:white; padding:6px 10px; border-radius:4px; border:none; cursor:pointer; font-weight:bold; }
  #dm-btn-profile:hover { background:#2277cc; }
  .blog-post { border:2px inset #99ccff; background:#e6f0ff; padding:10px; margin-bottom:10px; border-radius:4px; font-size:13px; font-family:'Courier New', monospace; }
  .blog-post .timestamp { font-size:11px; color:#333; margin-bottom:5px; }
  #new-post-container { margin-bottom:20px; }
  #new-post-input { width:100%; padding:8px; font-size:14px; border:2px solid #9966ff; border-radius:4px; resize:vertical; min-height:60px; margin-bottom:8px; }
  .notif-item { padding:6px 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .notif-item button { margin-left:5px; background:#3399ff; border:none; color:white; padding:2px 6px; border-radius:3px; cursor:pointer; font-size:12px; }
  .notif-item button:hover { background:#2277cc; }
  #song-player { margin:10px 0; }
  iframe { width:100%; height:200px; border:none; border-radius:6px; }
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <div class="logo">THE BLOG NETWORK</div>
    <div class="tagline">Chat with others!</div>
  </div>
  <nav>
    <button id="back-btn">â¬… Back</button>
  </nav>
</header>

<main id="profile-main">
  <h1>The Profile Place</h1>

  <div id="avatar-username-container">
    <div id="profile-avatar">
      <img id="avatar-preview" src="https://via.placeholder.com/150" alt="Avatar">
    </div>
    <input type="text" id="username-input" placeholder="Username">
    <!-- DM Button will be inserted here -->
  </div>

  <label for="bio-input">Bio:</label>
  <textarea id="bio-input"></textarea>

  <label for="movie-input">Favorite Movie/Series:</label>
  <input type="text" id="movie-input" placeholder="Optional">

  <label for="song-input">Favorite Song (YouTube URL):</label>
  <input type="url" id="song-input" placeholder="Paste YouTube link">
  <div id="song-player"></div>

  <label for="birthday-input">Birthday:</label>
  <input type="date" id="birthday-input">

  <label for="avatar-input">Profile Picture (URL):</label>
  <input type="url" id="avatar-input" placeholder="Paste image URL or leave blank">

  <label for="wallpaper-select">Profile Wallpaper:</label>
  <select id="wallpaper-select">
    <option value="#f0f4ff">Light Blue</option>
    <option value="#fff4f0">Light Orange</option>
    <option value="#f0fff4">Light Green</option>
    <option value="#f4f0ff">Light Purple</option>
  </select>

  <button id="save-btn">Save Changes</button>

  <h2>Friends</h2>
  <div id="friends-container"></div>
  <div id="friend-actions"></div>

  <h2>Friend Requests</h2>
  <div id="friend-requests-container"></div>

  <div id="new-post-container">
    <h2>New Blog Post</h2>
    <textarea id="new-post-input" placeholder="Write your post here..."></textarea>
    <button id="submit-post-btn">Post</button>
  </div>

  <h2>Recent Blog Posts</h2>
  <div id="blog-posts-container"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { 
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0", 
  authDomain:"the-blog-network.firebaseapp.com", 
  projectId:"the-blog-network", 
  storageBucket:"the-blog-network.appspot.com", 
  messagingSenderId:"857847462134", 
  appId:"1:857847462134:web:a22e9a6467a230632b94d7" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const SECRET_KEY = "MY_SECRET_KEY";

let currentUserID = localStorage.getItem('userId');
if (!currentUserID) {
  currentUserID = 'user_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  localStorage.setItem('userId', currentUserID);
}
const urlParams = new URLSearchParams(window.location.search);
const profileUserID = urlParams.get('user') || currentUserID;
const isOwnProfile = profileUserID === currentUserID;

const usernameInput=document.getElementById('username-input');
const bioInput=document.getElementById('bio-input');
const movieInput=document.getElementById('movie-input');
const songInput=document.getElementById('song-input');
const birthdayInput=document.getElementById('birthday-input');
const avatarInput=document.getElementById('avatar-input');
const wallpaperSelect=document.getElementById('wallpaper-select');
const saveBtn=document.getElementById('save-btn');
const avatarPreview=document.getElementById('avatar-preview');
const main=document.getElementById('profile-main');
const blogPostsContainer=document.getElementById('blog-posts-container');
const newPostInput=document.getElementById('new-post-input');
const submitPostBtn=document.getElementById('submit-post-btn');
const friendsContainer=document.getElementById('friends-container');
const friendRequestsContainer=document.getElementById('friend-requests-container');
const friendActions=document.getElementById('friend-actions');
const songPlayer=document.getElementById('song-player');
const newPostContainer=document.getElementById('new-post-container');
const avatarUsernameContainer = document.getElementById('avatar-username-container');

function formatTimestamp(date){
  const now=new Date(); 
  const diffMs=now-date; 
  const diffMins=Math.floor(diffMs/60000);
  if(diffMins<1)return'just now'; 
  if(diffMins===1)return'1 minute ago'; 
  if(diffMins<60)return`${diffMins} minutes ago`;
  const diffHrs=Math.floor(diffMins/60); 
  if(diffHrs===1)return'1 hour ago'; 
  if(diffHrs<24)return`${diffHrs} hours ago`;
  const diffDays=Math.floor(diffHrs/24); 
  if(diffDays===1)return'1 day ago'; 
  return`${diffDays} days ago`;
}

function getYouTubeEmbedURL(url){
  try{
    const urlObj=new URL(url);
    if(urlObj.hostname.includes("youtube.com") && urlObj.searchParams.get("v")){
      return "https://www.youtube.com/embed/"+urlObj.searchParams.get("v");
    }
    if(urlObj.hostname==="youtu.be"){
      return "https://www.youtube.com/embed/"+urlObj.pathname.slice(1);
    }
  }catch(e){ }
  return null;
}

// Load profile
async function loadProfile(){
  try{
    const doc=await db.collection('users').doc(profileUserID).get();
    const data=doc.exists?doc.data():{};
    usernameInput.value=data.username||'';
    bioInput.value=data.bio||'';
    movieInput.value=data.favoriteMovie||'';
    songInput.value=data.favoriteSong||'';
    birthdayInput.value=data.birthday||'';
    avatarInput.value=data.avatarURL||'';
    wallpaperSelect.value=data.wallpaper||'#f0f4ff';
if (data.wallpaper === 'gradient' && currentUserID === 'user_1755141089023') {
  if (!wallpaperSelect.querySelector(`option[value="gradient"]`)) {
    const gradientOption = document.createElement('option');
    gradientOption.value = 'gradient';
    gradientOption.text = 'Banner Gradient';
    wallpaperSelect.appendChild(gradientOption);
  }
  wallpaperSelect.value = 'gradient';
} else if (data.wallpaper === 'gradient' && currentUserID !== 'user_1755141089023') {
  wallpaperSelect.value = '#f0f4ff';
} else if (data.wallpaper === '#ffd700') {
  if (!wallpaperSelect.querySelector(`option[value="#ffd700"]`)) {
    const goldOption = document.createElement('option');
    goldOption.value = '#ffd700';
    goldOption.text = 'Gold';
    wallpaperSelect.appendChild(goldOption);
  }
  wallpaperSelect.value = '#ffd700';
} else {
  wallpaperSelect.value = data.wallpaper || '#f0f4ff';
}

if (wallpaperSelect.value === 'gradient' && currentUserID === 'user_1755141089023') {
  main.style.background = 'linear-gradient(90deg,#3399ff,#9966ff)';
} else if (wallpaperSelect.value === '#ffd700') {
  main.style.background = '#ffd700';
} else {
  main.style.background = wallpaperSelect.value;
}
  
    avatarPreview.src=avatarInput.value||'https://via.placeholder.com/150';


    songPlayer.innerHTML='';
    if(data.favoriteSong){
      const embedURL=getYouTubeEmbedURL(data.favoriteSong);
      if(embedURL){
        const iframe=document.createElement('iframe');
        iframe.src=embedURL;
        iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen=true;
        songPlayer.appendChild(iframe);
      }
    }

    if(!isOwnProfile){
      [usernameInput,bioInput,movieInput,songInput,birthdayInput,avatarInput,wallpaperSelect,saveBtn,newPostInput,submitPostBtn].forEach(el=>el.disabled=true);
      saveBtn.style.display='none'; submitPostBtn.style.display='none'; newPostContainer.style.display='none';
    }

    loadBlogPosts();
    loadFriends();
    loadFriendActions();
    loadFriendRequests();
    addDMButton();
  }catch(err){console.error('Error loading profile:',err);}
}

// Save profile
saveBtn.addEventListener('click',async()=>{
  const username=usernameInput.value.trim();
  if(!username) return alert('Username cannot be empty.');
  try{
    const usernameCheck=await db.collection('users').where('username','==',username).get();
    const isTaken=!usernameCheck.empty&&!(usernameCheck.docs.length===1&&usernameCheck.docs[0].id===currentUserID);
    if(isTaken) return alert('Username already taken!');

    if (wallpaperSelect.value === 'gradient' && currentUserID !== 'user_1755141089023') {
  alert('You are not authorized to use this wallpaper.');
  return;
}

    const profileData={
      username,
      bio:bioInput.value.trim(),
      favoriteMovie:movieInput.value.trim(),
      favoriteSong:songInput.value.trim(),
      birthday:birthdayInput.value,
      avatarURL:avatarInput.value.trim(),
      wallpaper:wallpaperSelect.value
    };

    await db.collection('users').doc(currentUserID).set(profileData,{merge:true});
    usernameInput.value = profileData.username;
    avatarPreview.src = profileData.avatarURL || 'https://preview.redd.it/made-a-frutiger-aero-default-pfp-v0-techv3ww70eb1.png?auto=webp&s=cef6cc3645c0fff280d25325f3b0a00c51038167';
    main.style.background = profileData.wallpaper;
    alert('Profile updated!');
  }catch(err){alert('Error saving profile: '+err.message);}
});

// Blog posts
function loadBlogPosts(){
  blogPostsContainer.innerHTML='Loading posts...';
  db.collection('users').doc(profileUserID)
    .collection('profilePosts')
    .orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
      blogPostsContainer.innerHTML='';
      if(snapshot.empty){ blogPostsContainer.innerHTML='<p>No posts yet.</p>'; return; }
      snapshot.forEach(doc=>{
        const data=doc.data();
        const postDiv=document.createElement('div');
        postDiv.className='blog-post';
        postDiv.innerHTML = `
          <div class="timestamp">
            ${data.username ? `<strong>${data.username}</strong> - ` : ''}
            ${data.timestamp?.toDate ? formatTimestamp(data.timestamp.toDate()) : ''}
          </div>
          ${data.content}
        `;
        blogPostsContainer.appendChild(postDiv);
      });
    }, err=>{
      console.error('Error loading posts:',err);
      blogPostsContainer.innerHTML='Error loading posts.';
    });
}

submitPostBtn.addEventListener('click', async () => {
  const content = newPostInput.value.trim();
  if (!content) return alert('Cannot post empty content.');
  try {
    const username = localStorage.getItem('username') || 'Anonymous';

    await db.collection('users').doc(currentUserID)
      .collection('profilePosts').add({
        content: content,
        username: username,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        key: SECRET_KEY
      });
    newPostInput.value = '';
  } catch (err) {
    alert('Error posting blog: ' + err.message);
  }
});

// Friends
async function loadFriends(){
  friendsContainer.innerHTML = 'Loading friends...';
  const snapshot = await db.collection('users').doc(profileUserID)
    .collection('friends').get();
  friendsContainer.innerHTML='';
  if(snapshot.empty){ friendsContainer.innerHTML='<p>No friends yet.</p>'; return; }
  snapshot.forEach(doc=>{
    const friend = doc.data();
    const a = document.createElement('a');
    a.href = '?user=' + doc.id;
    a.textContent = friend.username || doc.id;
    a.style.display='block';
    friendsContainer.appendChild(a);
  });
}

// Friend actions
async function loadFriendActions(){
  friendActions.innerHTML='';
  if(isOwnProfile) return;

  const friendDoc = await db.collection('users').doc(currentUserID)
    .collection('friends').doc(profileUserID).get();
  if(friendDoc.exists){
    const span=document.createElement('span');
    span.textContent='You are friends âœ…';
    friendActions.appendChild(span);
    return;
  }

  const reqDoc = await db.collection('users').doc(profileUserID)
    .collection('friendRequests').doc(currentUserID).get();
  if(reqDoc.exists){
    const span=document.createElement('span');
    span.textContent='Request Sent!';
    friendActions.appendChild(span);
    return;
  }

  const addBtn=document.createElement('button');
  addBtn.textContent='Add Friend';
  addBtn.addEventListener('click', async ()=>{
    try{
      const userDoc = await db.collection('users').doc(currentUserID).get();
      const username = userDoc.exists ? userDoc.data().username : 'Anonymous';
      await db.collection('users').doc(profileUserID)
        .collection('friendRequests').doc(currentUserID)
        .set({ fromUsername: username, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      friendActions.innerHTML='Request Sent!';
    }catch(err){ alert('Error sending request: '+err.message); }
  });
  friendActions.appendChild(addBtn);
}

// DM button
async function addDMButton(){
  if(isOwnProfile) return;

  const friendDoc = await db.collection('users').doc(currentUserID)
    .collection('friends').doc(profileUserID).get();
  if(!friendDoc.exists) return;

  const existingBtn = document.getElementById('dm-btn-profile');
  if(existingBtn) existingBtn.remove();

  const dmBtn = document.createElement('button');
  dmBtn.id='dm-btn-profile';
  dmBtn.textContent='Start a conversation!ðŸ’¬';
  dmBtn.addEventListener('click', ()=> {
    window.location.href = `messages.html?user=${encodeURIComponent(profileUserID)}`;
  });
  avatarUsernameContainer.appendChild(dmBtn);
}

// Friend requests
function loadFriendRequests(){
  friendRequestsContainer.innerHTML='Loading friend requests...';
  if(!isOwnProfile) return;
  db.collection('users').doc(currentUserID)
    .collection('friendRequests')
    .onSnapshot(snapshot=>{
      friendRequestsContainer.innerHTML='';
      if(snapshot.empty){ friendRequestsContainer.innerHTML='<p>No requests.</p>'; return; }
      snapshot.forEach(doc=>{
        const req=doc.data();
        const container=document.createElement('div');
        container.className='notif-item';
        const span=document.createElement('span');
        span.textContent=`${req.fromUsername || 'Unknown'} wants to be friends`;

        const acceptBtn=document.createElement('button');
        acceptBtn.textContent='Accept';
        acceptBtn.addEventListener('click', async ()=>{
          const fromUserId = doc.id;
          try{
            const fromUserDoc = await db.collection('users').doc(fromUserId).get();
            const fromUsername = fromUserDoc.exists ? fromUserDoc.data().username : 'Unknown';

            await db.collection('users').doc(currentUserID).collection('friends').doc(fromUserId).set({ username: fromUsername });
            await db.collection('users').doc(fromUserId).collection('friends').doc(currentUserID).set({ username: usernameInput.value });

            await db.collection('users').doc(currentUserID).collection('friendRequests').doc(fromUserId).delete();
          }catch(err){ alert('Error adding friend: '+err.message); }
        });

        const declineBtn=document.createElement('button');
        declineBtn.textContent='Decline';
        declineBtn.addEventListener('click', async ()=>{
          await db.collection('users').doc(currentUserID).collection('friendRequests').doc(doc.id).delete();
        });

        container.appendChild(span);
        container.appendChild(acceptBtn);
        container.appendChild(declineBtn);
        friendRequestsContainer.appendChild(container);
      });
    });
}

// Avatar & wallpaper preview
avatarInput.addEventListener('input',()=>avatarPreview.src=avatarInput.value||'https://via.placeholder.com/150');
wallpaperSelect.addEventListener('change',()=>{
  if (wallpaperSelect.value === 'gradient' && currentUserID === 'user_1755141089023') {
    main.style.background = 'linear-gradient(90deg,#3399ff,#9966ff)';
  } else if (wallpaperSelect.value === 'gradient' && currentUserID !== 'user_1755141089023') {
    wallpaperSelect.value = '#f0f4ff';
    main.style.background = '#f0f4ff';
    alert('You are not authorized to use this wallpaper.');
  } else {
    main.style.background = wallpaperSelect.value;
  }
});
// Back button
document.getElementById('back-btn').addEventListener('click',()=>window.location.href='index.html');

loadProfile();
</script>
</body>
</html>

















