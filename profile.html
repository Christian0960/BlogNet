<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Your Profile</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; color:#000080; user-select:none; background:#f0f4ff; }
  header { background:linear-gradient(90deg,#3399ff,#9966ff); padding:20px 30px; box-shadow:0 3px 6px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .logo-container { display:flex; align-items:baseline; gap:15px; }
  .logo { font-size:36px; font-weight:bold; color:#fff; }
  .tagline { font-size:18px; font-style:italic; font-weight:bold; color:#ffe066; }
  nav { display:flex; gap:10px; align-items:center; }
  button { padding:8px 14px; font-weight:bold; border-radius:3px; border:none; cursor:pointer; color:#000080; background:#ffcc00; box-shadow:1px 1px 0 #333; transition:background 0.2s; }
  button:hover { background:#ffff66; }
  main { max-width:700px; margin:30px auto; padding:20px; background:#ffffffcc; border:3px solid #9966ff; border-radius:6px; box-shadow:0 4px 10px rgba(153,102,255,0.3); transition:background 0.3s; }
  h1 { margin-bottom:10px; }
  label { display:block; margin:10px 0 5px; font-weight:bold; }
  input[type="text"], input[type="url"], input[type="date"], textarea, select { width:100%; padding:8px; font-size:14px; border:2px solid #9966ff; border-radius:4px; }
  textarea { resize:vertical; min-height:60px; }
  #friends-container p, #blog-posts-container p { margin:4px 0; }
  #avatar-username-container { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
  #profile-avatar img { width:150px; height:150px; border-radius:50%; object-fit:cover; background:#ccc; }
  #username-input { flex:1; font-size:20px; }
  .blog-post { border:2px inset #99ccff; background:#e6f0ff; padding:10px; margin-bottom:10px; border-radius:4px; font-size:13px; font-family:'Courier New', monospace; }
  .blog-post .timestamp { font-size:11px; color:#333; margin-bottom:5px; }
  #new-post-container { margin-bottom:20px; }
  #new-post-input { width:100%; padding:8px; font-size:14px; border:2px solid #9966ff; border-radius:4px; resize:vertical; min-height:60px; margin-bottom:8px; }
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <div class="logo">THE BLOG NETWORK</div>
    <div class="tagline">Chat with others!</div>
  </div>
  <nav>
    <button id="back-btn">â¬… Back</button>
  </nav>
</header>

<main id="profile-main">
  <h1>The Profile Place</h1>

  <div id="avatar-username-container">
    <div id="profile-avatar">
      <img id="avatar-preview" src="https://via.placeholder.com/150" alt="Avatar">
    </div>
    <input type="text" id="username-input" placeholder="Username">
  </div>

  <label for="bio-input">Bio:</label>
  <textarea id="bio-input"></textarea>

  <label for="movie-input">Favorite Movie:</label>
  <input type="text" id="movie-input" placeholder="Optional">

  <label for="song-input">Favorite Song:</label>
  <input type="text" id="song-input" placeholder="Optional">

  <label for="birthday-input">Birthday:</label>
  <input type="date" id="birthday-input">

  <label for="avatar-input">Profile Picture (URL):</label>
  <input type="url" id="avatar-input" placeholder="Paste image URL or leave blank">

  <label for="wallpaper-select">Profile Wallpaper:</label>
  <select id="wallpaper-select">
    <option value="#f0f4ff">Light Blue</option>
    <option value="#fff4f0">Light Orange</option>
    <option value="#f0fff4">Light Green</option>
    <option value="#f4f0ff">Light Purple</option>
  </select>

  <button id="save-btn">Save Changes</button>

  <h2>Friends</h2>
  <div id="friends-container"></div>
  <div id="friend-actions"></div>

  <div id="new-post-container">
    <h2>New Blog Post</h2>
    <textarea id="new-post-input" placeholder="Write your post here..."></textarea>
    <button id="submit-post-btn">Post</button>
  </div>

  <h2>Recent Blog Posts</h2>
  <div id="blog-posts-container"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain: "the-blog-network.firebaseapp.com",
  projectId: "the-blog-network",
  storageBucket: "the-blog-network.appspot.com",
  messagingSenderId: "857847462134",
  appId: "1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Stable unique userId
let currentUserID = localStorage.getItem('userId');
if (!currentUserID) {
  currentUserID = 'user_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  localStorage.setItem('userId', currentUserID);
}

// Check URL for ?user=OTHER_USER_ID
const urlParams = new URLSearchParams(window.location.search);
const profileUserID = urlParams.get('user') || currentUserID;
const isOwnProfile = profileUserID === currentUserID;

// Elements
const usernameInput = document.getElementById('username-input');
const bioInput = document.getElementById('bio-input');
const movieInput = document.getElementById('movie-input');
const songInput = document.getElementById('song-input');
const birthdayInput = document.getElementById('birthday-input');
const avatarInput = document.getElementById('avatar-input');
const wallpaperSelect = document.getElementById('wallpaper-select');
const saveBtn = document.getElementById('save-btn');
const avatarPreview = document.getElementById('avatar-preview');
const main = document.getElementById('profile-main');
const blogPostsContainer = document.getElementById('blog-posts-container');
const newPostInput = document.getElementById('new-post-input');
const submitPostBtn = document.getElementById('submit-post-btn');
const friendsContainer = document.getElementById('friends-container');
const friendActions = document.getElementById('friend-actions');

// Load profile
async function loadProfile() {
  try {
    const doc = await db.collection('users').doc(profileUserID).get();
    const data = doc.exists ? doc.data() : {};
    usernameInput.value = data.username || '';
    bioInput.value = data.bio || '';
    movieInput.value = data.favoriteMovie || '';
    songInput.value = data.favoriteSong || '';
    birthdayInput.value = data.birthday || '';
    avatarInput.value = data.avatarURL || '';
    wallpaperSelect.value = data.wallpaper || '#f0f4ff';
    avatarPreview.src = avatarInput.value || 'https://via.placeholder.com/150';
    main.style.background = wallpaperSelect.value;

    if (!isOwnProfile) {
      [usernameInput, bioInput, movieInput, songInput, birthdayInput, avatarInput, wallpaperSelect, saveBtn, newPostInput, submitPostBtn]
        .forEach(el => el.disabled = true);
      saveBtn.style.display = 'none';
      submitPostBtn.style.display = 'none';
    }

    loadFriends();
    setupFriendActions();
    loadBlogPosts();
  } catch(err){
    console.error('Error loading profile:', err);
  }
}

// Save profile changes with old username cleanup
saveBtn.addEventListener('click', async () => {
  const newUsername = usernameInput.value.trim();
  if (!newUsername) return alert('Username cannot be empty.');

  try {
    const usernameCheck = await db.collection('users')
      .where('username', '==', newUsername)
      .get();
    const isTaken = !usernameCheck.empty && !(usernameCheck.docs.length === 1 && usernameCheck.docs[0].id === currentUserID);
    if (isTaken) return alert('Username already taken! Choose another.');

    // Delete old username record if changed
    const currentDoc = await db.collection('users').doc(currentUserID).get();
    const oldUsername = currentDoc.exists ? currentDoc.data().username : null;
    if (oldUsername && oldUsername !== newUsername) {
      await db.collection('usernames').doc(oldUsername).delete().catch(()=>{});
    }

    // Update new username record
    await db.collection('usernames').doc(newUsername).set({userId: currentUserID});

    const profileData = {
      username: newUsername,
      bio: bioInput.value.trim(),
      favoriteMovie: movieInput.value.trim(),
      favoriteSong: songInput.value.trim(),
      birthday: birthdayInput.value,
      avatarURL: avatarInput.value.trim(),
      wallpaper: wallpaperSelect.value
    };

    Object.keys(profileData).forEach(key => localStorage.setItem(key, profileData[key]));
    await db.collection('users').doc(currentUserID).set(profileData, { merge: true });

    alert('Profile updated!');
    avatarPreview.src = avatarInput.value || 'https://via.placeholder.com/150';
    main.style.background = wallpaperSelect.value;
  } catch(err) {
    alert('Error saving profile: ' + err.message);
  }
});

// Avatar & wallpaper preview
avatarInput.addEventListener('input', () => avatarPreview.src = avatarInput.value || 'https://via.placeholder.com/150');
wallpaperSelect.addEventListener('change', () => main.style.background = wallpaperSelect.value);

// Load friends
async function loadFriends() {
  friendsContainer.innerHTML = '';
  const snapshot = await db.collection('users')
    .doc(profileUserID)
    .collection('friends')
    .get();

  if (snapshot.empty) {
    friendsContainer.innerHTML = '<p>No friends yet.</p>';
    return;
  }

  snapshot.forEach(doc => {
    const friend = doc.data();
    const div = document.createElement('p');
    div.textContent = friend.username || 'Unknown';
    friendsContainer.appendChild(div);
  });
}

// Setup friend actions
async function setupFriendActions() {
  friendActions.innerHTML = '';
  if (isOwnProfile) return;

  const friendDoc = await db.collection('users')
    .doc(currentUserID)
    .collection('friends')
    .doc(profileUserID)
    .get();

  if (friendDoc.exists) {
    friendActions.innerHTML = '<p>âœ… You are friends</p>';
    return;
  }

  const pending = await db.collection('users')
    .doc(profileUserID)
    .collection('notifications')
    .where('from', '==', currentUserID)
    .where('type', '==', 'friend_request')
    .get();

  if (!pending.empty) {
    friendActions.innerHTML = '<p>ðŸ“© Friend request sent</p>';
    return;
  }

  const btn = document.createElement('button');
  btn.textContent = 'âž• Add Friend';
  btn.addEventListener('click', async () => {
    try {
      await db.collection('users')
        .doc(profileUserID)
        .collection('notifications')
        .add({
          type: 'friend_request',
          from: currentUserID,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      alert('Friend request sent!');
      setupFriendActions();
    } catch(err) {
      alert('Error: ' + err.message);
    }
  });
  friendActions.appendChild(btn);
}

// Load profile blog posts
async function loadBlogPosts() {
  blogPostsContainer.innerHTML = '';
  const snapshot = await db.collection('users')
    .doc(profileUserID)
    .collection('profilePosts')
    .orderBy('timestamp', 'desc')
    .get();

  snapshot.forEach(doc => {
    const post = doc.data();
    const postDiv = document.createElement('div');
    postDiv.className = 'blog-post';
    postDiv.innerHTML = `<div class="timestamp">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : ''}</div>
                         <div class="content">${post.content}</div>`;
    blogPostsContainer.appendChild(postDiv);
  });
}

// Submit new blog post
submitPostBtn.addEventListener('click', async () => {
  const content = newPostInput.value.trim();
  if (!content) return alert('Post cannot be empty.');

  const postData = {
    content,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await db.collection('users')
      .doc(currentUserID)
      .collection('profilePosts')
      .add(postData);

    newPostInput.value = '';
    loadBlogPosts();
  } catch(err) {
    alert('Error posting blog: ' + err.message);
  }
});

// Back button
document.getElementById('back-btn').addEventListener('click', () => window.location.href = 'index.html');

// Initial load
loadProfile();
</script>
</body>
</html>
