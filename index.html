VERSION 0.139 - VERSION 1.0 RELEASES SOON!
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Blog Network</title>
<style>
  body {
    margin: 0;
    font-family: Arial,sans-serif;
    background: #f0f4ff url('https://www.transparenttextures.com/patterns/tileable-wood-print.png') repeat;
    color: #000080;
    user-select: none;
  }

  header {
    background: linear-gradient(90deg,#3399ff,#9966ff);
    padding: 20px 30px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    position: relative;
  }

  .logo-container {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .logo {
    font-size: 36px;
    color: #fff;
    font-weight: bold;
  }

  .tagline {
    font-size: 18px;
    color: #ffe066;
    font-style: italic;
    font-weight: bold;
    text-shadow: 1px 1px 0 #000033;
  }

  nav {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  button.filter-btn, #profile-btn, #dm-btn {
    background: #ffcc00;
    border: 2px solid #000080;
    border-radius: 3px;
    padding: 8px 10px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    color: #000080;
    box-shadow: 1px 1px 0 #333;
    transition: background 0.2s;
    position: relative;
  }

  button.filter-btn:hover, #profile-btn:hover, #dm-btn:hover {
    background: #ffff66;
  }

  button.filter-btn.active {
    background: #ffff99;
    border-color: #330066;
    box-shadow: 2px 2px 4px #660099;
  }

  main {
    max-width: 700px;
    margin: 25px auto;
    padding: 10px 20px;
    background: #ffffffcc;
    border: 3px solid #3399ff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    border-radius: 6px;
    min-height: 300px;
  }

  form#post-form {
    max-width: 700px;
    margin: 0 auto 25px auto;
    background: #ffffffcc;
    padding: 15px 20px;
    border: 3px solid #9966ff;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(153,102,255,0.5);
    display: flex;
    flex-direction: column;
  }

  input#username, textarea#post-content {
    width: 100%;
    padding: 8px;
    font-size: 14px;
    border: 2px solid #9966ff;
    border-radius: 4px;
    margin-bottom: 8px;
  }

  textarea#post-content {
    min-height: 60px; resize: vertical;
  }

  button#submit-post {
    margin-top:8px; background:#9966ff; border:none; padding:8px 16px; color:white; font-weight:bold; border-radius:4px; cursor:pointer; align-self:flex-end; transition:background 0.3s;
  }

  button#submit-post:hover {
    background: #7a3fcc;
  }

  .post {
    border: 2px inset #99ccff;
    background: #e6f0ff;
    padding: 15px;
    margin-bottom: 20px;
    font-size: 13px;
    font-family: 'Courier New', monospace;
    box-shadow: 1px 1px 0 #99ccff;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .post img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    cursor: pointer;
  }

  .post-content {
    display: flex;
    flex-direction: column;
  }

  .post-content .author a {
    text-decoration: none;
    color: #000080;
    font-weight: bold;
    cursor: pointer;
  }

  .post-content .author a:hover {
    text-decoration: underline;
  }

  footer {
    text-align: center;
    margin: 20px auto;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    color: #333;
  }

  #dm-dot {
    display:none;
    width:10px;
    height:10px;
    background:red;
    border-radius:50%;
    position:absolute;
    top:2px;
    right:2px;
  }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <a href='https://ko-fi.com/ruppeey' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi3.png?v=3' border='0' alt='Buy Me a Coffee' /></a>
    <div class="logo-container">
      <div class="logo">THE BLOG NETWORK</div>
      <div class="tagline">Chat with others!</div>
    </div>
  </div>
  <nav style="display:flex; gap:10px; align-items:center;">
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="filter-btn" data-filter="friends">Friends</button>
      <button class="filter-btn active" data-filter="public">Public Chat</button>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="profile-btn" title="Profile">üë§</button>
      <button id="dm-btn" title="Direct Messages">‚úâÔ∏è<span id="dm-dot"></span></button>
    </div>
  </nav>
</header>

<form id="post-form">
  <input type="text" id="username" placeholder="What's your name?" />
  <textarea id="post-content" placeholder="Have something to say?"></textarea>
  <button type="submit" id="submit-post">Post</button>
</form>

<main id="feed"></main>
<footer><em>EST. 2025 CREATED BY friend_ultra</em></footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ------------ Firebase ------------ */
const SECRET_KEY="MY_SECRET_KEY";
const firebaseConfig = {
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain:"the-blog-network.firebaseapp.com",
  projectId:"the-blog-network",
  storageBucket:"the-blog-network.appspot.com",
  messagingSenderId:"857847462134",
  appId:"1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ------------ User bootstrap ------------ */
let currentUserID = localStorage.getItem('userId');
async function initUserID() {
  if (!currentUserID) {
    currentUserID = 'user_'+Date.now()+'_'+Math.floor(Math.random()*1000);
    localStorage.setItem('userId', currentUserID);
    await db.collection('users').doc(currentUserID).set({
      username:'Unknown',
      avatarURL:'https://via.placeholder.com/40',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }
  if (!localStorage.getItem('lastDMsOpenedAt')) {
    localStorage.setItem('lastDMsOpenedAt', String(Date.now()));
  }
}
initUserID();

/* ------------ DOM refs ------------ */
const buttons = document.querySelectorAll('.filter-btn');
const feed = document.getElementById('feed');
const form = document.getElementById('post-form');
const textarea = document.getElementById('post-content');
const usernameInput = document.getElementById('username');
const profileBtn = document.getElementById('profile-btn');
const dmBtn = document.getElementById('dm-btn');
const dmDot = document.getElementById('dm-dot');

/* ------------ State ------------ */
let currentFilter='public';
let friendIds=new Set();
let lastSeenMap={};
const userCache={};

/* Prefill username */
if(localStorage.getItem('username')) usernameInput.value=localStorage.getItem('username');

/* ------------ Utils ------------ */
function sanitizeText(text) {
  const substitutions = { 'a':'[a@4]','b':'[b8]','c':'[c(]','e':'[e3]','g':'[g9]','i':'[i1!|]','l':'[l1|!]','o':'[o0]','s':'[s$5]','t':'[t7+]','z':'[z2]' };
  const badWords = ['fuck','shit','bitch','ass'];
  const patterns = badWords.map(word => {
    const letters = word.split('').map(c=>substitutions[c.toLowerCase()]||c);
    return new RegExp(letters.join('[\\W_]*'),'gi');
  });
  let cleanText = text;
  patterns.forEach(r=>{ cleanText = cleanText.replace(r, m=>'*'.repeat(m.length)); });
  return cleanText;
}

function formatTimestamp(date){
  const now=new Date(); const diffMs=now-date;
  const diffMins=Math.floor(diffMs/60000);
  if(diffMins<1)return'just now';
  if(diffMins===1)return'1 minute ago';
  if(diffMins<60)return`${diffMins} minutes ago`;
  const diffHrs=Math.floor(diffMins/60);
  if(diffHrs===1)return'1 hour ago';
  if(diffHrs<24)return`${diffHrs} hours ago`;
  const diffDays=Math.floor(diffHrs/24);
  if(diffDays===1)return'1 day ago';
  return `${diffDays} days ago`;
}

async function getUserData(userId){
  if(userCache[userId]) return userCache[userId];
  const doc = await db.collection('users').doc(userId).get();
  const data = doc.exists ? doc.data() : {username:'Unknown', avatarURL:'https://via.placeholder.com/40'};
  userCache[userId] = data;
  return data;
}

/* ------------ Navigation ------------ */
buttons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    buttons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter=btn.getAttribute('data-filter');
    renderFeed();
  });
});
profileBtn.addEventListener('click',()=>{ window.location.href=`profile.html?user=${encodeURIComponent(currentUserID)}`; });

/* ------------ DM Notification Dot ------------ */
function subscribeDMNotifications() {
  db.collection('users').doc(currentUserID).collection('dms')
    .onSnapshot(async conversations => {
      const lastOpen = Number(localStorage.getItem('lastDMsOpenedAt') || 0);
      let hasNew = false;

      const checks = conversations.docs.map(async conversation => {
        const friendId = conversation.id;
        const messagesSnap = await db.collection('users').doc(currentUserID)
          .collection('dms').doc(friendId)
          .collection('messages')
          .orderBy('timestamp','desc')
          .limit(1)
          .get();

        const latest = messagesSnap.docs[0]?.data();
        const ts = latest?.timestamp?.toDate().getTime() || 0;
        if (latest && latest.senderID !== currentUserID && ts > lastOpen) {
          hasNew = true;
        }
      });

      await Promise.all(checks);
      dmDot.style.display = hasNew ? 'block' : 'none';
    });
}

window.addEventListener('storage', e => { if(e.key==='lastDMsOpenedAt') dmDot.style.display='none'; });

dmBtn.addEventListener('click', () => {
  localStorage.setItem('lastDMsOpenedAt', String(Date.now()));
  dmDot.style.display='none';
  window.location.href='messages.html';
});

subscribeDMNotifications();

/* ------------ Friends + Posts (Realtime) ------------ */
let publicUnsub=null;
let profileUnsubs=[];
let cachedPublicPosts=[];
const friendPostsMap={};

function clearProfileUnsubs(){ profileUnsubs.forEach(u=>{ try{u(); }catch(e){} }); profileUnsubs=[]; }

function subscribePublicPosts(){
  if(publicUnsub) try{ publicUnsub(); }catch(e){}
  publicUnsub=db.collection('publicPosts')
    .orderBy('timestamp','desc')
    .onSnapshot(snap=>{
      cachedPublicPosts = snap.docs.map(d=>({id:d.id,data:d.data(),type:'public'}));
      if(currentFilter==='public') renderFeed();
    });
}

function subscribeProfilePosts(){
  clearProfileUnsubs();
  [...friendIds].forEach(uid=>{
    const unsub=db.collection('users').doc(uid).collection('profilePosts')
      .orderBy('timestamp','desc')
      .onSnapshot(snap=>{
        friendPostsMap[uid]=snap.docs.map(d=>({id:d.id,data:d.data(),type:'profile'}));
        if(currentFilter!=='public') renderFeed();
      });
    profileUnsubs.push(unsub);
  });
}

function subscribeFriends(){
  db.collection('users').doc(currentUserID).collection('friends')
    .onSnapshot(snap=>{
      friendIds = new Set();
      snap.forEach(doc=>friendIds.add(doc.id));
      friendIds.add(currentUserID);
      db.collection('users').doc(currentUserID).get().then(doc=>{
        if(doc.exists && doc.data().lastSeen) lastSeenMap=doc.data().lastSeen;
      });
      subscribeProfilePosts();
    });
}
subscribePublicPosts();
subscribeFriends();

/* ------------ Render feed ------------ */
async function renderFeed(){
  feed.innerHTML='';
  let posts = currentFilter==='public' ? cachedPublicPosts.slice() : Object.values(friendPostsMap).flat();
  posts.sort((a,b)=>{
    const ta=a.data.timestamp?.toDate().getTime()||0;
    const tb=b.data.timestamp?.toDate().getTime()||0;
    return tb-ta;
  });

  for(const p of posts){
    const post=p.data;
    const authorId=post.authorId;
    const userData = await getUserData(authorId);
    const article=document.createElement('article');
    article.className='post';
    article.dataset.type=p.type;
    article.dataset.author=authorId;

    article.innerHTML=`
      <img src="${userData.avatarURL}" alt="avatar" class="profile-link" data-userid="${authorId}">
      <div class="post-content">
        <div class="author"><a href="profile.html?user=${encodeURIComponent(authorId)}">${userData.username}</a></div>
        <div class="timestamp">${post.timestamp?.toDate ? formatTimestamp(post.timestamp.toDate()) : ''}</div>
        <div class="content">${post.content}</div>
      </div>
    `;
    feed.appendChild(article);
    article.querySelectorAll('.profile-link').forEach(img=>img.addEventListener('click',()=>window.location.href=`profile.html?user=${encodeURIComponent(authorId)}`));
  }
}

/* ------------ Posting ------------ */
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const content=textarea.value.trim();
  if(!content) return alert('Write something!');
  const newUsername=usernameInput.value.trim()||'Unknown';
  localStorage.setItem('username',newUsername);
  const userRef=db.collection('users').doc(currentUserID);
  const userDoc=await userRef.get();
  const existing=userDoc.exists ? userDoc.data() : {};
  await userRef.set({username:newUsername, avatarURL:existing.avatarURL||'https://via.placeholder.com/40'},{merge:true});

  try{
    const cleanContent = sanitizeText(content);
    if(currentFilter==='public'){
      await db.collection('publicPosts').add({
        authorId:currentUserID,
        content:cleanContent,
        timestamp:firebase.firestore.FieldValue.serverTimestamp(),
        type:'public',
        key:SECRET_KEY
      });
    } else {
      await db.collection('users').doc(currentUserID).collection('profilePosts').add({
        authorId:currentUserID,
        content:cleanContent,
        timestamp:firebase.firestore.FieldValue.serverTimestamp(),
        type:'profile',
        key:SECRET_KEY
      });
      lastSeenMap[currentUserID]=Date.now();
      await userRef.set({lastSeen:lastSeenMap},{merge:true});
    }
    textarea.value='';
  } catch(err){ alert('Error posting: '+err.message); }
});
</script>
</body>
</html>

