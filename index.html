<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Blog Network</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f0f4ff url('https://www.transparenttextures.com/patterns/tileable-wood-print.png') repeat; color:#000080; user-select:none; }
header { background:linear-gradient(90deg,#3399ff,#9966ff); padding:20px 30px; box-shadow:0 3px 6px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
.logo-container { display:flex; align-items:center; gap:15px; }
.logo { font-size:36px; color:#fff; font-weight:bold; }
.tagline { font-size:18px; color:#ffe066; font-style:italic; font-weight:bold; text-shadow:1px 1px 0 #000033; }
nav { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
button.filter-btn, #profile-btn, #notif-btn { background:#ffcc00; border:2px solid #000080; border-radius:3px; padding:8px 10px; font-weight:bold; font-size:14px; cursor:pointer; color:#000080; box-shadow:1px 1px 0 #333; transition:background 0.2s; }
button.filter-btn:hover, #profile-btn:hover, #notif-btn:hover { background:#ffff66; }
button.filter-btn.active { background:#ffff99; border-color:#330066; box-shadow:2px 2px 4px #660099; }
#notif-wrap { position:relative; }
#notif-count { position:absolute; top:-6px; right:-6px; background:#e02424; color:#fff; border-radius:10px; padding:2px 6px; font-size:11px; display:none; }
#notif-panel { position:absolute; right:0; top:42px; width:280px; max-height:320px; overflow:auto; background:#ffffff; border:2px solid #9966ff; box-shadow:0 6px 14px rgba(0,0,0,0.25); border-radius:6px; display:none; z-index:10; }
.notif-item { padding:10px; border-bottom:1px solid #eee; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
.notif-item.unread { background:#f5f0ff; font-weight:bold; }
.notif-empty { padding:14px; text-align:center; color:#555; font-size:13px; }
.notif-item button { margin-left:5px; background:#3399ff; border:none; color:white; padding:2px 6px; border-radius:3px; cursor:pointer; font-size:12px; }
.notif-item button:hover { background:#2277cc; }
main { max-width:700px; margin:25px auto; padding:10px 20px; background:#ffffffcc; border:3px solid #3399ff; box-shadow:0 4px 10px rgba(0,0,0,0.2); border-radius:6px; min-height:300px; }
form#post-form { max-width:700px; margin:0 auto 25px auto; background:#ffffffcc; padding:15px 20px; border:3px solid #9966ff; border-radius:6px; box-shadow:0 4px 8px rgba(153,102,255,0.5); display:flex; flex-direction:column; }
input#username, textarea#post-content, select#post-type { width:100%; padding:8px; font-size:14px; border:2px solid #9966ff; border-radius:4px; margin-bottom:8px; }
textarea#post-content { min-height:60px; resize:vertical; }
button#submit-post { margin-top:8px; background:#9966ff; border:none; padding:8px 16px; color:white; font-weight:bold; border-radius:4px; cursor:pointer; align-self:flex-end; transition:background 0.3s; }
button#submit-post:hover { background:#7a3fcc; }
.post { border:2px inset #99ccff; background:#e6f0ff; padding:15px; margin-bottom:20px; font-size:13px; font-family:'Courier New', monospace; box-shadow:1px 1px 0 #99ccff; display:flex; align-items:center; gap:10px; }
.post img { width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; }
.post-content { display:flex; flex-direction:column; }
.post-content .author a { text-decoration:none; color:#000080; font-weight:bold; cursor:pointer; }
.post-content .author a:hover { text-decoration:underline; }
footer { text-align:center; margin:20px auto; font-size:12px; font-family:'Courier New', monospace; color:#333; }
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <div class="logo">THE BLOG NETWORK</div>
    <div class="tagline">Chat with others!</div>
  </div>
  <nav>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="filter-btn active" data-filter="friends">Friends</button>
      <button class="filter-btn" data-filter="unseen">Unseen</button>
      <button class="filter-btn" data-filter="public">Public Chat</button>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="profile-btn" title="Profile">ðŸ‘¤</button>
      <div id="notif-wrap">
        <button id="notif-btn" title="Notifications">ðŸ””</button>
        <span id="notif-count">0</span>
        <div id="notif-panel"></div>
      </div>
    </div>
  </nav>
</header>

<form id="post-form">
  <input type="text" id="username" placeholder="What's your name?" />
  <select id="post-type">
    <option value="profile">Profile Post</option>
    <option value="public">Public Chat</option>
  </select>
  <textarea id="post-content" placeholder="Have something to say?"></textarea>
  <button type="submit" id="submit-post">Post</button>
</form>

<main id="feed"></main>

<footer><em>EST. 2025 CREATED BY friend_ultra</em></footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const SECRET_KEY="MY_SECRET_KEY";
let currentUserID = localStorage.getItem('userId');
if(!currentUserID){ currentUserID='user_'+Date.now()+'_'+Math.floor(Math.random()*1000); localStorage.setItem('userId',currentUserID); }

const firebaseConfig = {
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain:"the-blog-network.firebaseapp.com",
  projectId:"the-blog-network",
  storageBucket:"the-blog-network.appspot.com",
  messagingSenderId:"857847462134",
  appId:"1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const buttons=document.querySelectorAll('.filter-btn');
const feed=document.getElementById('feed');
const form=document.getElementById('post-form');
const textarea=document.getElementById('post-content');
const usernameInput=document.getElementById('username');
const postTypeSelect=document.getElementById('post-type');
const notifBtn=document.getElementById('notif-btn');
const notifCount=document.getElementById('notif-count');
const notifPanel=document.getElementById('notif-panel');
const profileBtn=document.getElementById('profile-btn');

let currentFilter='friends';
let friendIds=new Set();
if(localStorage.getItem('username')) usernameInput.value=localStorage.getItem('username');

function sanitizeText(text){return text;} // simplified
function formatTimestamp(date){const now=new Date();const diffMs=now-date;const diffMins=Math.floor(diffMs/60000);if(diffMins<1)return'just now';if(diffMins===1)return'1 minute ago';if(diffMins<60)return`${diffMins} minutes ago`;const diffHrs=Math.floor(diffMins/60);if(diffHrs===1)return'1 hour ago';if(diffHrs<24)return`${diffHrs} hours ago`;const diffDays=Math.floor(diffHrs/24);if(diffDays===1)return'1 day ago';return`${diffDays} days ago`;}

// Header buttons
buttons.forEach(btn=>{btn.addEventListener('click',()=>{buttons.forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentFilter=btn.getAttribute('data-filter'); applyCurrentFilter(); });});
profileBtn.addEventListener('click',()=>{ window.location.href=`profile.html?user=${encodeURIComponent(currentUserID)}`; });

// Subscribe friends
function subscribeFriends(){
  db.collection('users').doc(currentUserID).collection('friends').where('status','==','accepted')
    .onSnapshot(snap=>{ friendIds=new Set(); snap.forEach(doc=>friendIds.add(doc.id)); friendIds.add(currentUserID); fetchPosts(); fetchNotifications(); });
}
subscribeFriends();

// Fetch posts
let cachedPosts=[];
const userCache={};
async function fetchMissingUsers(authorIds){
  const missing=authorIds.filter(id=>!userCache[id]);
  if(!missing.length) return;
  const chunks=[]; while(missing.length) chunks.push(missing.splice(0,10));
  await Promise.all(chunks.map(list=>db.collection('users').where(firebase.firestore.FieldPath.documentId(),'in',list).get().then(s=>s.forEach(u=>userCache[u.id]=u.data()||{}))));
}

async function fetchPosts(){
  const postsPromises = [...friendIds].map(uid=>db.collection('users').doc(uid).collection('profilePosts').orderBy('timestamp','desc').get());
  const profileSnaps = await Promise.all(postsPromises);
  const profilePosts = profileSnaps.flatMap(snap => snap.docs.map(d=>({id:d.id,data:d.data(), type:'profile'})));
  const publicSnap = await db.collection('publicPosts').orderBy('timestamp','desc').get();
  const publicPosts = publicSnap.docs.map(d=>({id:d.id,data:d.data(), type:'public'}));
  cachedPosts = [...profilePosts, ...publicPosts];
  const authors=[...new Set(cachedPosts.map(p=>p.data.authorId).filter(Boolean))];
  await fetchMissingUsers(authors);
  renderFeed();
}

function renderFeed(){
  feed.innerHTML='';
  cachedPosts.forEach(p=>{
    const post=p.data;
    const authorId=post.authorId||'friend_alpha';
    const userData=userCache[authorId]||{username:authorId, avatarURL:'https://via.placeholder.com/40'};
    const article=document.createElement('article');
    article.className='post';
    article.dataset.type=p.type;
    article.dataset.author=authorId;
    article.innerHTML=`
      <img src="${userData.avatarURL}" alt="avatar" class="profile-link" data-userid="${authorId}">
      <div class="post-content">
        <div class="author"><a href="profile.html?user=${encodeURIComponent(authorId)}">${userData.username}</a></div>
        <div class="timestamp">${post.timestamp?formatTimestamp(post.timestamp.toDate()):''}</div>
        <div class="content">${post.content}</div>
      </div>
    `;
    feed.appendChild(article);
    article.querySelectorAll('.profile-link').forEach(img=>img.addEventListener('click',()=>window.location.href=`profile.html?user=${encodeURIComponent(authorId)}`));
  });
  applyCurrentFilter();
}

function applyCurrentFilter(){
  const posts=feed.querySelectorAll('.post');
  posts.forEach(el=>{
    const type=el.dataset.type;
    const author=el.dataset.author;
    let show=true;
    if(currentFilter==='public') show=(type==='public');
    else if(currentFilter==='friends') show=friendIds.has(author);
    else if(currentFilter==='unseen') show=(type==='profile' && !friendIds.has(author));
    el.style.display=show?'flex':'none';
  });
}

// Posting
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const content=textarea.value.trim();
  if(!content) return alert('Write something!');
  const newUsername=usernameInput.value.trim()||'friend_alpha';
  localStorage.setItem('username',newUsername);
  const type=postTypeSelect.value;
  try{
    const userRef=db.collection('users').doc(currentUserID);
    const userDoc=await userRef.get();
    const existing=userDoc.exists?userDoc.data():{};
    await userRef.set({username:newUsername, avatarURL:existing.avatarURL||'https://via.placeholder.com/40'},{merge:true});
    if(type==='profile'){
      await db.collection('users').doc(currentUserID).collection('profilePosts').add({authorId:currentUserID, content:sanitizeText(content), timestamp:firebase.firestore.FieldValue.serverTimestamp(), type:'profile', key:SECRET_KEY});
    } else {
      await db.collection('publicPosts').add({authorId:currentUserID, content:sanitizeText(content), timestamp:firebase.firestore.FieldValue.serverTimestamp(), type:'public', key:SECRET_KEY});
    }
    textarea.value='';
    fetchPosts();
  }catch(err){alert('Error posting: '+err.message);}
});

// --- NOTIFICATIONS & FRIEND REQUESTS ---
notifBtn.addEventListener('click',()=>{ notifPanel.style.display = notifPanel.style.display==='none'?'block':'none'; });

async function fetchNotifications(){
  const notifSnap = await db.collection('users').doc(currentUserID).collection('friendRequests').orderBy('timestamp','desc').get();
  notifPanel.innerHTML='';
  if(notifSnap.empty){ notifPanel.innerHTML='<div class="notif-empty">No notifications</div>'; notifCount.style.display='none'; return; }
  notifCount.style.display='inline';
  notifCount.textContent = notifSnap.size;
  notifSnap.forEach(doc=>{
    const data=doc.data();
    const div=document.createElement('div');
    div.className='notif-item unread';
    div.innerHTML=`<span>${data.fromUsername || 'Unknown'} sent a friend request</span>`;
    const acceptBtn=document.createElement('button'); acceptBtn.textContent='Accept';
    const rejectBtn=document.createElement('button'); rejectBtn.textContent='Reject';
    acceptBtn.onclick = async ()=>{
      await db.collection('users').doc(currentUserID).collection('friends').doc(doc.id).set({status:'accepted'});
      await db.collection('users').doc(doc.id).collection('friends').doc(currentUserID).set({status:'accepted'});
      await db.collection('users').doc(currentUserID).collection('friendRequests').doc(doc.id).delete();
      fetchNotifications();
      subscribeFriends();
    };
    rejectBtn.onclick = async ()=>{
      await db.collection('users').doc(currentUserID).collection('friendRequests').doc(doc.id).delete();
      fetchNotifications();
    };
    div.appendChild(acceptBtn); div.appendChild(rejectBtn);
    notifPanel.appendChild(div);
  });
}
</script>
</body>
</html>
