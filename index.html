<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Blog Network</title>
<style>
body {
  margin:0; font-family:Arial,sans-serif;
  background:#f0f4ff url('https://www.transparenttextures.com/patterns/tileable-wood-print.png') repeat;
  color:#000080; user-select:none;
}
header {
  background:linear-gradient(90deg,#3399ff,#9966ff);
  padding:20px 30px; box-shadow:0 3px 6px rgba(0,0,0,0.3);
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
.logo-container { display:flex; align-items:center; gap:15px; }
.logo { font-size:36px; color:#fff; font-weight:bold; }
.tagline { font-size:18px; color:#ffe066; font-style:italic; font-weight:bold; text-shadow:1px 1px 0 #000033; }
nav { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }

button.filter-btn {
  background:#ffcc00; border:2px solid #000080; border-radius:3px;
  padding:8px 14px; font-weight:bold; font-size:12px; cursor:pointer;
  color:#000080; box-shadow:1px 1px 0 #333; transition:background 0.2s; user-select:none;
}
button.filter-btn:hover { background:#ffff66; }
button.filter-btn.active { background:#ffff99; border-color:#330066; box-shadow:2px 2px 4px #660099; }

#profile-btn, #notif-btn, #add-friend-btn, #remove-friend-btn {
  background:#ffcc00; border:2px solid #000080; border-radius:3px;
  padding:8px 10px; font-weight:bold; font-size:14px; cursor:pointer;
  color:#000080; box-shadow:1px 1px 0 #333; transition:background 0.2s;
}
#profile-btn:hover, #notif-btn:hover, #add-friend-btn:hover, #remove-friend-btn:hover { background:#ffff66; }

#notif-wrap { position:relative; }
#notif-count {
  position:absolute; top:-6px; right:-6px; background:#e02424; color:#fff;
  border-radius:10px; padding:2px 6px; font-size:11px; display:none;
}
#notif-panel {
  position:absolute; right:0; top:42px; width:280px; max-height:320px; overflow:auto;
  background:#ffffff; border:2px solid #9966ff; box-shadow:0 6px 14px rgba(0,0,0,0.25);
  border-radius:6px; display:none; z-index:10;
}
.notif-item {
  padding:10px; border-bottom:1px solid #eee; font-size:13px;
}
.notif-item.unread { background:#f5f0ff; font-weight:bold; }
.notif-empty { padding:14px; text-align:center; color:#555; font-size:13px; }

main {
  max-width:700px; margin:25px auto; padding:10px 20px;
  background:#ffffffcc; border:3px solid #3399ff;
  box-shadow:0 4px 10px rgba(0,0,0,0.2); border-radius:6px; min-height:300px;
}
form#post-form {
  max-width:700px; margin:0 auto 25px auto; background:#ffffffcc;
  padding:15px 20px; border:3px solid #9966ff; border-radius:6px;
  box-shadow:0 4px 8px rgba(153,102,255,0.5); display:flex; flex-direction:column;
}
input#username, textarea#post-content {
  width:100%; padding:8px; font-size:14px; border:2px solid #9966ff; border-radius:4px;
}
textarea#post-content { min-height:60px; resize:vertical; }
button#submit-post {
  margin-top:8px; background:#9966ff; border:none;
  padding:8px 16px; color:white; font-weight:bold;
  border-radius:4px; cursor:pointer; align-self:flex-end; transition:background 0.3s;
}
button#submit-post:hover { background:#7a3fcc; }

.post {
  border:2px inset #99ccff; background:#e6f0ff; padding:15px; margin-bottom:20px;
  font-size:13px; font-family:'Courier New', monospace;
  box-shadow:1px 1px 0 #99ccff; display:flex; align-items:center; gap:10px;
}
.post img { width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; }
.post-content { display:flex; flex-direction:column; }
.post-content .author a { text-decoration:none; color:#000080; font-weight:bold; cursor:pointer; }
.post-content .author a:hover { text-decoration:underline; }

footer { text-align:center; margin:20px auto; font-size:12px; font-family:'Courier New', monospace; color:#333; }

.friend-controls {
  display:flex; gap:10px; margin-bottom:10px;
}
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <div class="logo">THE BLOG NETWORK</div>
    <div class="tagline">Chat with others!</div>
  </div>
  <nav>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="filter-btn active" data-filter="friends">Friends</button>
      <button class="filter-btn" data-filter="unseen">Unseen</button>
      <button class="filter-btn" data-filter="public">Public Chat</button>
    </div>

    <!-- Notifications + Profile + Friend actions -->
    <div style="display:flex; gap:10px; align-items:center;">
      <div id="notif-wrap">
        <button id="notif-btn" title="Notifications">ðŸ””</button>
        <span id="notif-count">0</span>
        <div id="notif-panel"></div>
      </div>
      <a href="profile.html"><button id="profile-btn" title="Your Profile">ðŸ‘¤</button></a>
      <button id="add-friend-btn" title="Add Friend">âž• Friend</button>
      <button id="remove-friend-btn" title="Remove Friend">âž– Friend</button>
    </div>
  </nav>
</header>

<form id="post-form">
  <input type="text" id="username" placeholder="Your username" />
  <textarea id="post-content" placeholder="Write your post here..."></textarea>
  <button type="submit" id="submit-post">Post</button>
</form>

<main id="feed"></main>

<footer>
  <em>EST. 2025 CREATED BY friend_alpha</em>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ----------------------
// Stable unique userId
// ----------------------
let currentUserID = localStorage.getItem('userId');
if (!currentUserID) {
  currentUserID = 'user_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  localStorage.setItem('userId', currentUserID);
}

// ----------------------
// Firebase init
// ----------------------
const firebaseConfig = {
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain:"the-blog-network.firebaseapp.com",
  projectId:"the-blog-network",
  storageBucket:"the-blog-network.appspot.com",
  messagingSenderId:"857847462134",
  appId:"1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ----------------------
// UI refs
// ----------------------
const buttons = document.querySelectorAll('.filter-btn');
const feed = document.getElementById('feed');
const form = document.getElementById('post-form');
const textarea = document.getElementById('post-content');
const usernameInput = document.getElementById('username');
const notifBtn = document.getElementById('notif-btn');
const notifCount = document.getElementById('notif-count');
const notifPanel = document.getElementById('notif-panel');
const addFriendBtn = document.getElementById('add-friend-btn');
const removeFriendBtn = document.getElementById('remove-friend-btn');

let currentFilter = 'friends';
let friendIds = new Set();

// Load username from localStorage
if(localStorage.getItem('username')) usernameInput.value = localStorage.getItem('username');

// ----------------------
// Bad words filter
// ----------------------
const badWords=['nigger','retard','shit','nigga','fuck','bitch','bastard','crap','douche','dick','cunt','cock','pussy','tits','dickhead','slut','whore','motherfucker'];
function sanitizeText(text){let s=text;badWords.forEach(w=>{s=s.replace(new RegExp(`\\b${w}\\b`,'gi'),'****')});return s;}

// ----------------------
// Time helper
// ----------------------
function formatTimestamp(date){
  const now=new Date();
  const diffMs=now-date;
  const diffMins=Math.floor(diffMs/60000);
  if(diffMins<1) return 'just now';
  if(diffMins===1) return '1 minute ago';
  if(diffMins<60) return `${diffMins} minutes ago`;
  const diffHrs=Math.floor(diffMins/60);
  if(diffHrs===1) return '1 hour ago';
  if(diffHrs<24) return `${diffHrs} hours ago`;
  const diffDays=Math.floor(diffHrs/24);
  if(diffDays===1) return '1 day ago';
  return `${diffDays} days ago`;
}

// ----------------------
// Filters
// ----------------------
buttons.forEach(btn => {
  btn.addEventListener('click', ()=>{
    buttons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.getAttribute('data-filter');
    applyCurrentFilter();
  });
});

// ----------------------
// FRIENDS subscription
// ----------------------
function subscribeFriends() {
  db.collection('users').doc(currentUserID).collection('friends')
    .where('status','==','accepted')
    .onSnapshot(snap=>{
      friendIds = new Set();
      snap.forEach(doc=>friendIds.add(doc.id));
      friendIds.add(currentUserID);
      applyCurrentFilter();
    });
}
subscribeFriends();

// ----------------------
// Posts
// ----------------------
let cachedPosts = [];
const userCache = {};

function fetchMissingUsers(authorIds) {
  const missing = authorIds.filter(id => !userCache[id]);
  if (!missing.length) return Promise.resolve();
  const chunks = [];
  while (missing.length) chunks.push(missing.splice(0,10));
  return Promise.all(chunks.map(list =>
    db.collection('users').where(firebase.firestore.FieldPath.documentId(),'in',list).get()
      .then(s=>s.forEach(u=>userCache[u.id]=u.data() || {}))
  ));
}

function renderFeed() {
  feed.innerHTML='';
  cachedPosts.forEach(p=>{
    const post = p.data;
    const authorId = post.authorId || 'friend_alpha';
    const userData = userCache[authorId] || { username: authorId, avatarURL: 'https://via.placeholder.com/40' };
    const article = document.createElement('article');
    article.className='post';
    article.dataset.type = post.type || 'public';
    article.dataset.author = authorId;
    article.innerHTML=`
      <img src="${userData.avatarURL}" alt="avatar" class="profile-link" data-userid="${authorId}">
      <div class="post-content">
        <div class="author"><a href="profile.html?user=${encodeURIComponent(authorId)}">${userData.username}</a></div>
        <div class="timestamp">${post.timestamp?formatTimestamp(post.timestamp.toDate()):''}</div>
        <div class="content">${post.content}</div>
      </div>
    `;
    feed.appendChild(article);
    article.querySelectorAll('.profile-link').forEach(img=>{
      img.addEventListener('click', ()=> window.location.href = `profile.html?user=${encodeURIComponent(authorId)}`);
    });
  });
  applyCurrentFilter();
}

function applyCurrentFilter() {
  const posts = feed.querySelectorAll('.post');
  posts.forEach(el=>{
    const type = el.dataset.type || 'public';
    const author = el.dataset.author || '';
    let show=true;

    if(currentFilter==='public') {
      show = true; // show all posts as public chat
    } else if(currentFilter==='friends') {
      show = friendIds.has(author);
    } else if(currentFilter==='unseen') {
      show = (type==='public' && author!==currentUserID);
    }
    el.style.display = show?'flex':'none';
  });
}

// ----------------------
// Real-time posts
// ----------------------
db.collection('posts').orderBy('timestamp','desc').onSnapshot(async snapshot=>{
  cachedPosts = snapshot.docs.map(d=>({id:d.id,data:d.data()}));
  const authors=[...new Set(cachedPosts.map(p=>p.data.authorId).filter(Boolean))];
  await fetchMissingUsers(authors);
  renderFeed();
});

// ----------------------
// Notifications
// ----------------------
let notifUnreads=0;
function subscribeNotifications() {
  db.collection('users').doc(currentUserID).collection('notifications')
    .orderBy('createdAt','desc')
    .onSnapshot(snap=>{
      const items=[];
      notifUnreads=0;
      snap.forEach(doc=>{
        const n=doc.data();
        items.push({id:doc.id,...n});
        if(!n.read) notifUnreads++;
      });
      drawNotifications(items);
    });
}
subscribeNotifications();

function drawNotifications(items) {
  notifCount.style.display = notifUnreads>0?'inline-block':'none';
  notifCount.textContent = notifUnreads;
  notifPanel.innerHTML='';
  if(!items.length){
    const empty=document.createElement('div'); empty.className='notif-empty';
    empty.textContent='No notifications yet.'; notifPanel.appendChild(empty); return;
  }
  items.forEach(n=>{
    const div=document.createElement('div');
    div.className='notif-item'+(!n.read?' unread':'');
    const when = n.createdAt ? formatTimestamp(n.createdAt.toDate()) : 'just now';
    div.innerHTML=`<div>${n.text || '(no text)'}<div style="font-size:11px;color:#555;margin-top:4px;">${when}</div></div>`;
    div.addEventListener('click', async ()=>{
      await db.collection('users').doc(currentUserID).collection('notifications').doc(n.id)
        .set({read:true},{merge:true});
    });
    notifPanel.appendChild(div);
  });
}

notifBtn.addEventListener('click',async ()=>{
  notifPanel.style.display = notifPanel.style.display==='block'?'none':'block';
  if(notifPanel.style.display==='block'){
    const snap = await db.collection('users').doc(currentUserID).collection('notifications').where('read','==',false).get();
    const batch = db.batch();
    snap.forEach(doc=> batch.set(doc.ref,{read:true},{merge:true}));
    await batch.commit();
  }
});
document.addEventListener('click',e=>{
  if(!document.getElementById('notif-wrap').contains(e.target)) notifPanel.style.display='none';
});

// ----------------------
// Posting
// ----------------------
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const content = textarea.value.trim();
  if(!content) return alert('Please write something before posting!');
  const newUsername = (usernameInput.value.trim() || 'friend_alpha');
  localStorage.setItem('username',newUsername);
  try {
    const userRef = db.collection('users').doc(currentUserID);
    const userDoc = await userRef.get();
    const existing = userDoc.exists?userDoc.data():{};
    const usernameCheck = await db.collection('users').where('username','==',newUsername).get();
    if(!userDoc.exists && !usernameCheck.empty) return alert('Username taken');
    await userRef.set({username:newUsername,avatarURL:existing.avatarURL||'https://via.placeholder.com/40'},{merge:true});
    await db.collection('posts').add({
      authorId:currentUserID,
      content:sanitizeText(content),
      timestamp:firebase.firestore.FieldValue.serverTimestamp(),
      type:currentFilter
    });
    textarea.value='';
  } catch(err){ alert('Error posting: '+err.message); }
});

// ----------------------
// Friend management
// ----------------------
addFriendBtn.addEventListener('click',async ()=>{
  const uname = prompt('Enter username to add as friend:');
  if(!uname) return;
  const userSnap = await db.collection('users').where('username','==',uname).get();
  if(userSnap.empty) return alert('User not found');
  const friendId = userSnap.docs[0].id;
  if(friendId===currentUserID) return alert('Cannot add yourself');
  await db.collection('users').doc(currentUserID).collection('friends').doc(friendId)
    .set({status:'pending',since:firebase.firestore.FieldValue.serverTimestamp()});
  alert('Friend request sent!');
});

removeFriendBtn.addEventListener('click',async ()=>{
  const uname = prompt('Enter username to remove from friends:');
  if(!uname) return;
  const userSnap = await db.collection('users').where('username','==',uname).get();
  if(userSnap.empty) return alert('User not found');
  const friendId = userSnap.docs[0].id;
  await db.collection('users').doc(currentUserID).collection('friends').doc(friendId).delete();
  alert('Friend removed!');
});
</script>
</body>
</html>
