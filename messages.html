<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Blog Network - Direct Messages</title>
<style>
  body {
    margin: 0;
    font-family: Arial,sans-serif;
    background: #f0f4ff url('https://www.transparenttextures.com/patterns/tileable-wood-print.png') repeat;
    color: #000080;
  }
  header {
    background: linear-gradient(90deg,#3399ff,#9966ff);
    padding: 20px 30px;
    box-shadow:0 3px 6px rgba(0,0,0,0.3);
    display:flex;
    align-items:center;
    gap:10px;
    color:white;
    font-size:20px;
    font-weight:bold;
  }
  #back-btn {
    padding:4px 8px;
    font-size:14px;
    border:none;
    border-radius:4px;
    background:#ffcc00;
    color:#000080;
    cursor:pointer;
  }
  #back-btn:hover { background:#ffff66; }
  .container { display:flex; height:calc(100vh - 70px); }
  .sidebar {
    width:25%;
    background:#e6f0ff;
    border-right:3px solid #3399ff;
    overflow-y:auto;
  }
  .sidebar h2 { text-align:center; margin:12px 0; font-size:16px; font-family:'Courier New',monospace; }
  .conversation {
    padding:10px;
    border-bottom:2px inset #99ccff;
    cursor:pointer;
    background:#ffffffcc;
    font-family:'Courier New',monospace;
  }
  .conversation:hover { background:#d9e6ff; }
  .chat {
    flex:1;
    display:flex;
    flex-direction:column;
    background:#ffffffcc;
    border-left:3px solid #9966ff;
  }
  .messages { flex:1; padding:15px; overflow-y:auto; }
  .message {
    margin:8px 0;
    padding:10px;
    border-radius:6px;
    max-width:70%;
    font-size:13px;
    font-family:'Courier New',monospace;
    box-shadow:1px 1px 0 #99ccff;
  }
  .sent { background:#e6f0ff; border:2px inset #99ccff; align-self:flex-end; }
  .received { background:#fff9e6; border:2px inset #ffcc00; align-self:flex-start; }
  .input-box { display:flex; padding:10px; border-top:3px solid #3399ff; background:#fff; }
  .input-box input { flex:1; padding:8px; border:2px solid #9966ff; border-radius:4px; font-size:14px; }
  .input-box button { margin-left:10px; padding:8px 14px; border:none; border-radius:4px; background:#9966ff; color:white; font-weight:bold; cursor:pointer; transition:background 0.3s; }
  .input-box button:hover { background:#7a3fcc; }
  footer { text-align:center; margin:10px auto; font-size:12px; font-family:'Courier New',monospace; color:#333; }
</style>
</head>
<body>
<header>
  <button id="back-btn">← Back</button>
  THE BLOG NETWORK — Direct Messages
</header>
<div class="container">
  <div class="sidebar">
    <h2>Chats</h2>
  </div>
  <div class="chat">
    <div class="messages">
      <div class="message received">Select a friend to start chatting!</div>
    </div>
    <div class="input-box">
      <input type="text" placeholder="Type your message..." />
      <button>Send</button>
    </div>
  </div>
</div>
<footer><em>EST. 2025 CREATED BY friend_ultra</em></footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain:"the-blog-network.firebaseapp.com",
  projectId:"the-blog-network",
  storageBucket:"the-blog-network.appspot.com",
  messagingSenderId:"857847462134",
  appId:"1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Current user ID
let currentUserID = localStorage.getItem('userId');
if(!currentUserID){
  currentUserID = 'user_'+Date.now()+'_'+Math.floor(Math.random()*1000);
  localStorage.setItem('userId', currentUserID);
}

// Elements
const messagesDiv = document.querySelector('.messages');
const inputBox = document.querySelector('.input-box input');
const sendBtn = document.querySelector('.input-box button');
const conversationsDiv = document.querySelector('.sidebar');
const backBtn = document.getElementById('back-btn');

let selectedFriendID = null;
let friendIds = new Set();
let messagesUnsub = null;

backBtn.addEventListener('click', () => { 
  localStorage.setItem('lastDMsOpenedAt', String(Date.now())); // mark as read
  window.location.href='index.html';
});

// Real-time friend list
db.collection('users').doc(currentUserID).collection('friends')
  .onSnapshot(snapshot=>{
    friendIds.clear();
    conversationsDiv.innerHTML='<h2>Chats</h2>';
    if(snapshot.empty){
      const p=document.createElement('p'); p.textContent='No friends yet.'; conversationsDiv.appendChild(p); return;
    }
    snapshot.forEach(doc=>{
      friendIds.add(doc.id);
      const div=document.createElement('div');
      div.className='conversation';
      div.textContent=doc.data().username||'Unknown';
      div.dataset.userid=doc.id;
      div.addEventListener('click',()=>selectConversation(doc.id, div.textContent));
      conversationsDiv.appendChild(div);
    });
  });

// Select a conversation
function selectConversation(friendID, friendName){
  selectedFriendID=friendID;
  messagesDiv.innerHTML=`<div class="message received">Chatting with ${friendName}</div>`;

  if(messagesUnsub){ messagesUnsub(); messagesUnsub=null; }

  const messagesRef=db.collection('users').doc(currentUserID)
    .collection('dms').doc(friendID).collection('messages').orderBy('timestamp','asc');

  messagesUnsub=messagesRef.onSnapshot(snapshot=>{
    messagesDiv.innerHTML='';
    snapshot.forEach(doc=>{
      const msg=doc.data();
      const div=document.createElement('div');
      div.className='message '+(msg.senderID===currentUserID?'sent':'received');
      div.textContent=msg.content;
      messagesDiv.appendChild(div);
      if(msg.senderID!==currentUserID && !msg.read){ doc.ref.update({read:true}).catch(console.error); }
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

// Send a message
sendBtn.addEventListener('click', async()=>{
  if(!selectedFriendID)return alert('Select a friend to message!');
  const content=inputBox.value.trim();
  if(!content)return;
  if(!friendIds.has(selectedFriendID))return alert('You can only message friends!');

  const messageData = { 
  senderID: currentUserID, 
  content, 
  timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
  read: false,
  key: "MY_SECRET_KEY"  
};

  const messageData={
    senderID:currentUserID,
    content,
    timestamp:firebase.firestore.FieldValue.serverTimestamp(),
    read:false
  };

  try{
    const currentUserDMRef=db.collection('users').doc(currentUserID).collection('dms').doc(selectedFriendID);
    const friendDMRef=db.collection('users').doc(selectedFriendID).collection('dms').doc(currentUserID);

    // Ensure DM docs exist
    await currentUserDMRef.set({createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    await friendDMRef.set({createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});

    // Add message to both users
    await currentUserDMRef.collection('messages').add(messageData);
    await friendDMRef.collection('messages').add(messageData);

    inputBox.value='';
  }catch(err){ alert('Error sending message: '+err.message); }
});
</script>
</body>
</html>

