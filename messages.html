<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Direct Messages - The Blog Network</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f0f4ff; color:#000080; }
header { background:linear-gradient(90deg,#3399ff,#9966ff); padding:15px; display:flex; align-items:center; color:white; font-weight:bold; }
header button { margin-right:10px; cursor:pointer; background:#ffcc00; border:2px solid #000080; border-radius:3px; padding:5px 10px; font-weight:bold; color:#000080; }
.container { display:flex; height:calc(100vh-60px); }
.sidebar { width:25%; background:#e6f0ff; overflow-y:auto; border-right:3px solid #3399ff; padding:10px; }
.conversation { padding:8px; margin-bottom:4px; background:#fff; border:1px solid #99ccff; cursor:pointer; }
.conversation:hover { background:#d9e6ff; }
.chat { flex:1; display:flex; flex-direction:column; background:#ffffffcc; border-left:3px solid #9966ff; }
.messages { flex:1; padding:15px; overflow-y:auto; }
.message { margin:5px 0; padding:8px; border-radius:5px; max-width:70%; font-family:'Courier New', monospace; }
.sent { background:#e6f0ff; align-self:flex-end; border:1px inset #99ccff; }
.received { background:#fff9e6; align-self:flex-start; border:1px inset #ffcc00; }
.input-box { display:flex; padding:10px; border-top:3px solid #3399ff; background:#fff; }
.input-box input { flex:1; padding:8px; border:2px solid #9966ff; border-radius:4px; }
.input-box button { margin-left:10px; padding:8px 14px; border:none; border-radius:4px; background:#9966ff; color:white; font-weight:bold; cursor:pointer; }
.input-box button:hover { background:#7a3fcc; }
</style>
</head>
<body>
<header>
  <button onclick="window.location.href='index.html'">Back</button>
  Direct Messages
</header>

<div class="container">
  <div class="sidebar">
    <h3>Friends</h3>
  </div>
  <div class="chat">
    <div class="messages"></div>
    <div class="input-box">
      <input type="text" placeholder="Type your message..." />
      <button>Send</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const SECRET_KEY = "MY_SECRET_KEY";
let currentUserID = localStorage.getItem('userId') || ('user_'+Date.now()+'_'+Math.floor(Math.random()*1000));
localStorage.setItem('userId', currentUserID);

const firebaseConfig = {
  apiKey:"AIzaSyBGNJwqrVv4lMPBTXiwwhv81cxCrIYF6V0",
  authDomain:"the-blog-network.firebaseapp.com",
  projectId:"the-blog-network",
  storageBucket:"the-blog-network.appspot.com",
  messagingSenderId:"857847462134",
  appId:"1:857847462134:web:a22e9a6467a230632b94d7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const sidebar = document.querySelector('.sidebar');
const messagesDiv = document.querySelector('.messages');
const inputBox = document.querySelector('.input-box input');
const sendBtn = document.querySelector('.input-box button');

let currentFriendID = null;
let friends = new Set();

// Load friends
async function loadFriends(){
  const snap = await db.collection('users').doc(currentUserID).collection('friends').get();
  friends.clear();
  sidebar.innerHTML = '<h3>Friends</h3>';
  snap.forEach(doc=>{
    friends.add(doc.id);
    const div = document.createElement('div');
    div.className = 'conversation';
    div.textContent = doc.id;
    div.addEventListener('click', ()=>openChat(doc.id));
    sidebar.appendChild(div);
  });
  if(friends.size === 0){
    const div = document.createElement('div');
    div.textContent = 'No friends yet.';
    sidebar.appendChild(div);
  }
}
loadFriends();

// Open chat
function openChat(friendId){
  currentFriendID = friendId;
  messagesDiv.innerHTML = '';
  const chatID = [currentUserID, friendId].sort().join('_'); // single collection per pair
  db.collection('dms').doc(chatID).collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snap=>{
      messagesDiv.innerHTML='';
      snap.forEach(doc=>{
        const m = doc.data();
        const div = document.createElement('div');
        div.className='message '+(m.senderID===currentUserID?'sent':'received');
        div.textContent=m.content;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}

// Send message
sendBtn.addEventListener('click', async ()=>{
  const text = inputBox.value.trim();
  if(!text) return;
  if(!currentFriendID) return alert('Select a friend!');
  if(!friends.has(currentFriendID)) return alert('Can only message friends!');
  const chatID = [currentUserID, currentFriendID].sort().join('_');
  try{
    await db.collection('dms').doc(chatID).collection('messages').add({
      senderID: currentUserID,
      content: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      key: SECRET_KEY
    });
    inputBox.value='';
  }catch(err){ alert('Error: '+err.message); }
});
</script>
</body>
</html>
