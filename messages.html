<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Blog Network - Direct Messages</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f0f4ff url('https://www.transparenttextures.com/patterns/tileable-wood-print.png') repeat;
    color: #000080;
  }

  header {
    background: linear-gradient(90deg, #3399ff, #9966ff);
    padding: 20px 30px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    color: white;
    font-size: 20px;
    font-weight: bold;
  }

  header button.back-btn {
    background: #ffcc00;
    border: 2px solid #000080;
    border-radius: 3px;
    padding: 5px 10px;
    font-weight: bold;
    cursor: pointer;
    color: #000080;
    margin-right: 15px;
  }

  .container {
    display: flex;
    height: calc(100vh - 70px);
  }

  /* Sidebar for conversations */
  .sidebar {
    width: 25%;
    background: #e6f0ff;
    border-right: 3px solid #3399ff;
    overflow-y: auto;
  }

  .sidebar h2 {
    text-align: center;
    margin: 12px 0;
    font-size: 16px;
    font-family: 'Courier New', monospace;
  }

  .conversation {
    padding: 10px;
    border-bottom: 2px inset #99ccff;
    cursor: pointer;
    background: #ffffffcc;
    font-family: 'Courier New', monospace;
  }

  .conversation:hover {
    background: #d9e6ff;
  }

  /* Chat area */
  .chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #ffffffcc;
    border-left: 3px solid #9966ff;
  }

  .messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
  }

  .message {
    margin: 8px 0;
    padding: 10px;
    border-radius: 6px;
    max-width: 70%;
    font-size: 13px;
    font-family: 'Courier New', monospace;
    box-shadow: 1px 1px 0 #99ccff;
  }

  .sent {
    background: #e6f0ff;
    border: 2px inset #99ccff;
    align-self: flex-end;
  }

  .received {
    background: #fff9e6;
    border: 2px inset #ffcc00;
    align-self: flex-start;
  }

  .input-box {
    display: flex;
    padding: 10px;
    border-top: 3px solid #3399ff;
    background: #fff;
  }

  .input-box input {
    flex: 1;
    padding: 8px;
    border: 2px solid #9966ff;
    border-radius: 4px;
    font-size: 14px;
  }

  .input-box button {
    margin-left: 10px;
    padding: 8px 14px;
    border: none;
    border-radius: 4px;
    background: #9966ff;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }

  .input-box button:hover {
    background: #7a3fcc;
  }

  footer {
    text-align: center;
    margin: 10px auto;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    color: #333;
  }
</style>
</head>
<body>
  <header>
    <div>
      <button class="back-btn" onclick="window.location.href='index.html'">Back</button>
      THE BLOG NETWORK â€” Direct Messages
    </div>
  </header>

  <div class="container">
    <!-- Sidebar with list of conversations -->
    <div class="sidebar">
      <h2>Chats</h2>
      <!-- Friends will be dynamically loaded here -->
    </div>

    <!-- Chat area -->
    <div class="chat">
      <div class="messages"></div>
      <div class="input-box">
        <input type="text" placeholder="Type your message..." />
        <button>Send</button>
      </div>
    </div>
  </div>

  <footer><em>EST. 2025 CREATED BY friend_ultra</em></footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  const SECRET_KEY = "MY_SECRET_KEY";
  let currentUserID = localStorage.getItem('userId');
  if(!currentUserID){
    currentUserID='user_'+Date.now()+'_'+Math.floor(Math.random()*1000);
    localStorage.setItem('userId', currentUserID);
  }

  const db = firebase.firestore();

  const sidebar = document.querySelector('.sidebar');
  const messagesDiv = document.querySelector('.messages');
  const inputBox = document.querySelector('.input-box input');
  const sendBtn = document.querySelector('.input-box button');

  let currentFriendID = null;
  let friendIds = new Set();

  // Load friends
  async function loadFriends() {
    const snap = await db.collection('users').doc(currentUserID).collection('friends').get();
    friendIds.clear();
    sidebar.innerHTML = '<h2>Chats</h2>';
    snap.forEach(doc => {
      friendIds.add(doc.id);
      const div = document.createElement('div');
      div.className = 'conversation';
      div.textContent = doc.id;
      div.addEventListener('click', () => openChat(doc.id));
      sidebar.appendChild(div);
    });
    if(friendIds.size === 0) {
      const div = document.createElement('div');
      div.textContent = 'No friends yet.';
      sidebar.appendChild(div);
    }
  }

  loadFriends();

  // Open chat with friend
  function openChat(friendId){
    currentFriendID = friendId;
    messagesDiv.innerHTML = '';
    db.collection('users').doc(currentUserID).collection('dms')
      .doc(friendId).collection('messages')
      .orderBy('timestamp')
      .onSnapshot(snap => {
        messagesDiv.innerHTML = '';
        snap.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.className = 'message ' + (msg.senderID === currentUserID ? 'sent' : 'received');
          div.textContent = msg.content;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
  }

  // Send message
  sendBtn.addEventListener('click', async () => {
    const content = inputBox.value.trim();
    if(!content) return;
    if(!currentFriendID) return alert('Select a friend first!');
    if(!friendIds.has(currentFriendID)) return alert('You can only message friends!');
    
    try{
      await db.collection('users').doc(currentUserID).collection('dms')
        .doc(currentFriendID).collection('messages').add({
          senderID: currentUserID,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          key: SECRET_KEY
        });
      inputBox.value = '';
    } catch(err){
      alert('Error sending message: ' + err.message);
    }
  });
  </script>
</body>
</html>
